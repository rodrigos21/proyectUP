name: cicd build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: build with Maven
      run: mvn clean install
      working-directory: ./tp.integrador
      
    - name: Define version
      id: vars
      run: echo "VERSION=1.0.${{ github.run_number }}" >> $GITHUB_ENV
      
 #   - name: Build & push Docker image
 #     uses: mr-smithers-excellent/docker-build-push@v6
 #     with:
 #       image: rodrigos21/devops-github-actions
 #       tags: ${{ env.VERSION }},latest
 #       registry: docker.io
 #       dockerfile: tp.integrador/Dockerfile
 #       context: tp.integrador
 #       username: ${{ secrets.DOCKER_USERNAME }}
 #       password: ${{ secrets.DOCKER_PASSWORD }}
 #       #buil-args: |
 #       buildArgs: | 
 #           DB_URL=${{ secrets.DB_URL }}
 #           DB_USERNAME=${{ secrets.DB_USERNAME }}
 #           DB_PASSWORD=${{ secrets.DB_PASSWORD }}
 
    - name: Build & push Docker image
      uses: docker/build-push-action@v4
      with:
        context: tp.integrador 
        file: tp.integrador/Dockerfile 
        tags: |
          docker.io/${{ secrets.DB_USERNAME }}/devops-github-actions:${{ env.VERSION }}
          docker.io/user/name:latest
        push: true  
        build-args: |
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        secrets: |
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}
